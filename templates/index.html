<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finance Agents</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Finance Multi-Agent System</h1>
    <p class="text-center text-muted">RAG • Market • Portfolio • Goal • Router</p>

    <div class="card mb-3">
      <div class="card-body">
        <input type="file" id="fileInput" accept=".xlsx,.xls" class="form-control mb-2"/>
        <button onclick="uploadFile()" class="btn btn-outline-primary btn-sm">Upload Portfolio</button>
        <small id="uploadStatus" class="text-success"></small>
      </div>
    </div>

    <div id="chat" class="card" style="height: 60vh; overflow-y: auto; padding: 1rem;"></div>

    <div class="input-group mt-3">
      <input type="text" id="userInput" class="form-control" placeholder="Ask finance..." />
      <button onclick="sendMessage()" class="btn btn-success">Send</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');

    function addMessage(text, role) {
      const div = document.createElement('div');
      div.className = `mb-3 p-3 rounded ${role === 'user' ? 'bg-primary text-white ms-auto' : 'bg-white border'}`
      div.style.maxWidth = '80%';
      div.innerHTML = text.replace(/\n/g, '<br>');
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      input.value = '';

      const res = await fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: msg})
      });
      const data = await res.json();
      addMessage(data.response || data.error, 'assistant');
    }

    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Select file");

      const form = new FormData();
      form.append('file', file);

      const res = await fetch('/upload', {method: 'POST', body: form});
      const data = await res.json();
      document.getElementById('uploadStatus').textContent = data.success ? `Uploaded: ${data.filename}` : data.error;
    }

    input.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
  </script>
</body>
</html>